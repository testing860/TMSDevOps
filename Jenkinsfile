pipeline {
    agent any
    
    environment {
        GITHUB_SSH_CREDENTIAL_ID = 'f2279fbb-b675-4191-bb6e-5e5c0d1421a5'
        DB_PASSWORD     = credentials('tms-db-password')
        JWT_KEY         = credentials('tms-jwt-key')
        ADMIN_PASSWORD  = credentials('tms-admin-password')
        APP_URLS        = credentials('tms-app-urls')
    }
    
    stages {

        /* =============================
           CHECKOUT
        ============================== */
        stage('Checkout from GitHub') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'git@github.com:testing860/TMSDevOps.git',
                        credentialsId: "${GITHUB_SSH_CREDENTIAL_ID}"
                    ]]
                ])
                sh """
                    echo "Repository checked out into: \$(pwd)"
                """
            }
        }

        /* =============================
           BUILD + TEST
        ============================== */
        stage('Build & Test Application') {
            steps {
                sh """
                    echo "Building .NET solution..."
                    dotnet build --configuration Release

                    echo "Running tests..."
                    dotnet test --configuration Release --logger 'trx' || echo 'Tests completed'
                """
            }
        }

        /* =============================
           CREATE .ENV FILE
        ============================== */
        stage('Create Secure Environment File') {
            steps {
                sh """
cat > .env << EOF
# ===== AUTO-GENERATED BY JENKINS - DO NOT COMMIT =====

# Database
DB_SERVER=localhost
DB_NAME=TaskManagementSystem
DB_USER=sa
DB_PASSWORD='${DB_PASSWORD}'

# JWT
JWT_KEY='${JWT_KEY}'
JWT_ISSUER=TMSAPI
JWT_AUDIENCE=TMSWebClient

# Admin Seeding
ADMIN_EMAIL=admin@tms.com
ADMIN_PASSWORD='${ADMIN_PASSWORD}'
ADMIN_DISPLAYNAME=Admin

# ASP.NET Runtime
ASPNETCORE_ENVIRONMENT=Production
ASPNETCORE_URLS='${APP_URLS}'
EOF

echo "Secure .env file created (secrets hidden)"
                """
            }
        }

        /* =============================
           PUBLISH + DEPLOY
        ============================== */
        stage('Publish & Deploy') {
            steps {
                script {
                    sh """
                        echo "Publishing API..."
                        dotnet publish TMS.API/TMS.API.csproj -c Release -o ./publish-api --runtime linux-x64

                        echo "Publishing Web (Blazor WASM)..."
                        dotnet publish TMS.Web/TMS.Web.csproj -c Release -o ./publish-web --runtime linux-x64

                        echo "Deploying into /opt/tms-app..."

                        sudo mkdir -p /opt/tms-app/api
                        sudo mkdir -p /opt/tms-app/web

                        sudo systemctl stop tms-api.service 2>/dev/null || true

                        sudo rm -rf /opt/tms-app/api/*
                        sudo cp -r ./publish-api/* /opt/tms-app/api/
                        sudo cp .env /opt/tms-app/api/

                        sudo rm -rf /opt/tms-app/web/*
                        sudo cp -r ./publish-web/wwwroot/* /opt/tms-app/web/

                        sudo chown -R ec:ec /opt/tms-app

                        # Create systemd service (first time only)
                        if [ ! -f /etc/systemd/system/tms-api.service ]; then
                            sudo tee /etc/systemd/system/tms-api.service << 'API_SERVICE'
[Unit]
Description=TMS API Backend
After=network.target

[Service]
WorkingDirectory=/opt/tms-app/api
ExecStart=/usr/bin/dotnet TMS.API.dll
EnvironmentFile=/opt/tms-app/api/.env
Restart=always
RestartSec=10
User=ec
Group=ec

[Install]
WantedBy=multi-user.target
API_SERVICE
                        fi

                        # Install nginx if needed
                        if ! command -v nginx > /dev/null; then
                            sudo apt-get update
                            sudo apt-get install -y nginx
                        fi

                        # Nginx config
                        sudo tee /etc/nginx/sites-available/tms << 'NGINX_CONFIG'
server {
    listen 7130;
    server_name _;

    root /opt/tms-app/web;

    location / {
        try_files \$uri \$uri/ /index.html;
        index index.html;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location /api {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location /hubs {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
    }

    location /health {
        proxy_pass http://localhost:5000/health;
        access_log off;
    }
}
NGINX_CONFIG

                        sudo ln -sf /etc/nginx/sites-available/tms /etc/nginx/sites-enabled/
                        sudo rm -f /etc/nginx/sites-enabled/default

                        sudo nginx -t
                        sudo systemctl restart nginx

                        sudo systemctl daemon-reload
                        sudo systemctl enable tms-api.service
                        sudo systemctl start tms-api.service

                        sudo ufw allow 7130/tcp 2>/dev/null || true

                        sleep 5

                        echo "Testing API..."
                        API_STATUS=\$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/health || echo failed)
                        echo "API Health: \$API_STATUS"

                        echo "Testing Web..."
                        WEB_STATUS=\$(curl -s -o /dev/null -w "%{http_code}" http://localhost:7130/ || echo failed)
                        echo "Web Status: \$WEB_STATUS"

                        echo "Deployment complete!"
                    """
                }
            }
        }
    }

    post {
        success {
            echo "üéâ Pipeline succeeded!"
        }
        failure {
            echo "‚ùå Pipeline failed ‚Äî check logs."
        }
    }
}

